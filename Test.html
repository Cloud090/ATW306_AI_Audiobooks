<!DOCTYPE html>
<html>
<head>
<title>API connect Test</title>
</head>

<body>

<h3>API URL</h3>
<input id="apiUrl" value="" style="width:400px;">
<button id="loadUrlBtn">Load from Render</button>
<button id="connectBtn">Connect</button>
<div id="status" style="margin-top:10px;"></div>

<hr>

<h3>Text</h3>
<textarea id="storyText" rows="4" cols="60">If I had a dollar for every dollar I had, I would have a dollar.</textarea>

<h3>Persona</h3>
<select id="persona">
    <option>Unemotional</option>
    <option>Calm</option>
    <option selected>Neutral</option>
    <option>Dramatic</option>
</select>

<h3>SFX Style</h3>
<select id="sfxstyle">
    <option>None</option>
    <option>Subtle</option>
    <option selected>Balanced</option>
    <option>Cinematic</option>
</select>

<h3>Voice Preset</h3>
<select id="voiceName">
    <option value="1001">Voice A</option>
    <option value="1002">Voice B</option>
    <option value="1003">Voice C</option>
</select>

<br><br>
<button id="runBtn">Generate</button>

<h3>Output JSON</h3>
<pre id="result"></pre>

<h3>Audio Output</h3>
<audio id="audioOut" controls></audio>

<script type="module">
    import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

    let client = null;

    // Load URL from Render
    document.getElementById("loadUrlBtn").onclick = async () => {
        const status = document.getElementById("status");
        status.innerText = "Fetching URL from Render...";

        try {
            const resp = await fetch("https://audioapi-g2ru.onrender.com/current");
            const data = await resp.json();

            if (data.url) {
                document.getElementById("apiUrl").value = data.url;
                status.innerText = "Loaded from Render";
            } else {
                status.innerText = "Render returned no URL.";
            }
        } catch (e) {
            status.innerText = "Error fetching from Render: " + e;
            console.error(e);
        }
    };

    // Connect to Gradio
    document.getElementById("connectBtn").onclick = async () => {
        const url = document.getElementById("apiUrl").value.trim();
        const status = document.getElementById("status");
        status.innerText = "Connecting...";

        try {
            client = await Client.connect(url);
            status.innerText = "Connected.";
        } catch (e) {
            status.innerText = "Connection failed: " + e;
            console.error(e);
        }
    };

    // Generate audiobook
    document.getElementById("runBtn").onclick = async () => {
        const resultBox = document.getElementById("result");
        const audioElem = document.getElementById("audioOut");

        if (!client) {
            resultBox.innerText = "Not connected.";
            return;
        }

        resultBox.innerText = "Running...";
        audioElem.src = ""; // clear audio

        const text = document.getElementById("storyText").value;
        const persona = document.getElementById("persona").value;
        const sfx = document.getElementById("sfxstyle").value;
        const voiceName = document.getElementById("voiceName").value;

        try {
            const output = await client.predict("/predict", {
                text,
                persona,
                sfxStyle: sfx,
                voiceAudio: null,
                voiceName
            });

            resultBox.innerText = JSON.stringify(output, null, 2);

            // Get audio
            const audioFile = output?.data?.[1];
            const audioUrl = audioFile?.url;

            console.log("Extracted audio URL:", audioUrl);

            if (audioUrl) {
                audioElem.src = audioUrl;
                audioElem.load();
                audioElem.play();
            } else {
                console.warn("No audio URL received from API.");
            }

        } catch (e) {
            console.error(e);
            resultBox.innerText = "Error: " + e;
        }
    };
</script>

</body>
</html>
